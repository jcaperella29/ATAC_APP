Bootstrap: docker
From: bioconductor/bioconductor_docker:RELEASE_3_17

%labels
    Maintainer ATAC DevOps ðŸ§¬
    App ATAC-seq Shiny Viewer (multi-species ready)

%environment
    export PORT=8787
    export SHINY_PORT=8787
    export DEBIAN_FRONTEND=noninteractive
    export MAKEFLAGS="-j4"

%post
    set -e
    apt-get update && apt-get install -y \
        libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libgit2-dev \
        libglu1-mesa \
        libxkbcommon-x11-0 \
        libharfbuzz-dev \
        libfribidi-dev \
        libfreetype6-dev \
        libbz2-dev \
        liblzma-dev \
        libz-dev \
        libncurses-dev \
        libxt-dev \
        libpng-dev \
        libjpeg-dev \
        libtiff5-dev \
        libicu-dev \
        zlib1g-dev \
        pandoc \
        libudunits2-dev \
        libgdal-dev \
        libgeos-dev \
        libproj-dev \
        libglpk-dev \
        libx11-dev \
        libxext-dev \
        libfftw3-dev \
        libboost-all-dev \
        libeigen3-dev \
        libhdf5-dev \
        libreadline-dev \
        libgsl-dev \
        libtbb-dev \
        libzstd-dev \
        && apt-get clean

    # --- Install core CRAN packages
    Rscript -e "install.packages(c('shiny','shinyjs','plotly','DT','markdown','enrichR','randomForest','pROC','uwot','umap'), repos='https://cloud.r-project.org')"

    # --- Install Bioconductor packages (multi-species)
    Rscript -e "BiocManager::install(c(
        'GenomicRanges','GenomicFeatures','AnnotationDbi',
        'TFBSTools','JASPAR2020','motifmatchr',
        'org.Hs.eg.db','TxDb.Hsapiens.UCSC.hg38.knownGene','BSgenome.Hsapiens.UCSC.hg38',
        'org.Mm.eg.db','TxDb.Mmusculus.UCSC.mm10.knownGene','BSgenome.Mmusculus.UCSC.mm10',
        'org.Dr.eg.db','TxDb.Drerio.UCSC.danRer11.refGene','BSgenome.Drerio.UCSC.danRer11',
        'org.Dm.eg.db','TxDb.Dmelanogaster.UCSC.dm6.ensGene','BSgenome.Dmelanogaster.UCSC.dm6'
    ), ask=FALSE, update=TRUE, dependencies=TRUE)"

    # --- Verify critical objects load
    Rscript -e "stopifnot(requireNamespace('GenomicRanges', quietly=TRUE))"
    Rscript -e "stopifnot(requireNamespace('motifmatchr', quietly=TRUE))"
    Rscript -e "stopifnot(requireNamespace('JASPAR2020', quietly=TRUE))"
    Rscript -e "stopifnot(requireNamespace('TxDb.Hsapiens.UCSC.hg38.knownGene', quietly=TRUE))"
    Rscript -e "stopifnot(requireNamespace('TxDb.Mmusculus.UCSC.mm10.knownGene', quietly=TRUE))"
    Rscript -e "stopifnot(requireNamespace('TxDb.Drerio.UCSC.danRer11.refGene', quietly=TRUE))"
    Rscript -e "stopifnot(requireNamespace('TxDb.Dmelanogaster.UCSC.dm6.ensGene', quietly=TRUE))"

%files
    app.R /app/app.R
    email_log.R /app/email_log.R

%runscript
    exec R -e "shiny::runApp('/app', port=8787, host='0.0.0.0')"
